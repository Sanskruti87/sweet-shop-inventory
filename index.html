<meta http-equiv="refresh" content="0; url=/dashboard.tsx" />
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sweet Bliss Inventory Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { background: #fdf9f6; color: #333; }
    .sidebar { width: 220px; background: #fff3f0; }
    .sidebar a { display: block; padding: 12px 16px; border-radius: 8px; margin: 4px 8px; }
    .sidebar a.active { background: #ff6b6b; color: #fff; }
    .card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .category-card { background: #fff7f7; padding: 16px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  </style>
</head>
<body class="flex h-screen">

  <!-- Sidebar -->
  <aside class="sidebar p-4 flex flex-col">
    <h1 class="text-2xl font-bold text-pink-600 mb-6">Sweet Bliss</h1>
    <nav>
      <a href="#" class="active" onclick="showSection('dashboard')">Dashboard</a>
      <a href="#" onclick="showSection('inventory')">Inventory</a>
      <a href="#" onclick="showSection('addItem')">Add Item</a>
      <a href="#" onclick="showSection('categories')">Categories</a>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="flex-1 overflow-y-auto p-6">
    <!-- DASHBOARD -->
    <section id="dashboard" class="space-y-6">
      <h2 class="text-3xl font-bold">Dashboard</h2>
      <p class="text-gray-600">Welcome to Sweet Bliss Inventory Management</p>
      <div class="grid grid-cols-4 gap-4" id="dashboard-stats"></div>
      <div class="grid grid-cols-2 gap-4">
        <div class="card">
          <h3 class="font-semibold mb-2">Stock Distribution by Category</h3>
          <canvas id="stockChart"></canvas>
        </div>
        <div class="card">
          <h3 class="font-semibold mb-2">Category Distribution</h3>
          <canvas id="pieChart"></canvas>
        </div>
      </div>
    </section>

    <!-- INVENTORY -->
    <section id="inventory" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Inventory</h2>
      <table class="w-full text-left border">
        <thead class="bg-gray-200">
          <tr><th>Name</th><th>Category</th><th>Stock</th><th>Price/kg</th><th>Actions</th></tr>
        </thead>
        <tbody id="inventory-table" class="bg-white"></tbody>
      </table>
    </section>

    <!-- ADD ITEM -->
    <section id="addItem" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Add New Item</h2>
      <form id="itemForm" class="space-y-4 max-w-md">
        <input type="text" id="name" placeholder="Item Name" class="w-full border rounded p-2" required>
        <input type="text" id="category" placeholder="Category" class="w-full border rounded p-2" required>
        <input type="number" id="stock" placeholder="Stock" class="w-full border rounded p-2" required>
        <input type="number" id="price" placeholder="Price per Kg" class="w-full border rounded p-2" required>
        <textarea id="description" placeholder="Description" class="w-full border rounded p-2"></textarea>
        <button class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">Add Item</button>
      </form>
    </section>

    <!-- CATEGORIES -->
    <section id="categories" class="hidden">
      <h2 class="text-2xl font-bold mb-4">Categories</h2>
      <div class="grid grid-cols-3 gap-4 category-grid"></div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const API_BASE = "http://localhost:8080/api";

    function showSection(id) {
      document.querySelectorAll("main section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
      document.querySelector(`.sidebar a[onclick*='${id}']`).classList.add("active");

      if (id === "inventory") loadInventory();
      if (id === "categories") loadCategories();
      if (id === "dashboard") loadDashboard();
    }

    // ---- LOAD INVENTORY ----
    async function loadInventory() {
      const tbody = document.getElementById("inventory-table");
      tbody.innerHTML = "<tr><td colspan='5'>Loading...</td></tr>";
      try {
        const res = await fetch(`${API_BASE}/items`);
        const items = await res.json();
        tbody.innerHTML = items.map(i => `
          <tr>
            <td>${i.name}</td>
            <td>${i.category}</td>
            <td>${i.stock}</td>
            <td>₹${i.pricePerKg}</td>
            <td><button onclick="deleteItem(${i.id})" class="text-red-500">Delete</button></td>
          </tr>
        `).join('');
      } catch (e) {
        tbody.innerHTML = "<tr><td colspan='5'>Error loading inventory</td></tr>";
      }
    }

    async function deleteItem(id) {
      if (!confirm("Delete this item?")) return;
      await fetch(`${API_BASE}/items/${id}`, { method: "DELETE" });
      loadInventory();
    }

    // ---- ADD ITEM ----
    document.getElementById("itemForm").addEventListener("submit", async e => {
      e.preventDefault();
      const newItem = {
        name: name.value,
        category: category.value,
        stock: +stock.value,
        pricePerKg: +price.value,
        description: description.value
      };
      const res = await fetch(`${API_BASE}/items`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(newItem)
      });
      if (res.ok) alert("Item added!");
      else alert("Failed to add item");
    });

    // ---- LOAD CATEGORIES ----
    async function loadCategories() {
      const grid = document.querySelector(".category-grid");
      grid.innerHTML = "<p>Loading...</p>";
      try {
        const res = await fetch(`${API_BASE}/categories`);
        const cats = await res.json();
        grid.innerHTML = cats.map(c => `
          <div class="category-card">
            <h3 class="font-semibold">${c.name}</h3>
            <p>${c.items} items</p>
            <p>${c.stock} total stock</p>
            <p>₹${c.value.toFixed(2)}k</p>
          </div>
        `).join('');
      } catch (e) {
        grid.innerHTML = "<p>Error loading categories</p>";
      }
    }

    // ---- DASHBOARD ----
    async function loadDashboard() {
      try {
        const res = await fetch(`${API_BASE}/items`);
        const items = await res.json();
        const totalItems = items.length;
        const totalStock = items.reduce((s,i) => s + i.stock, 0);
        const totalValue = items.reduce((s,i) => s + (i.stock * i.pricePerKg), 0);
        const lowStock = items.filter(i => i.stock < 10).length;

        document.getElementById("dashboard-stats").innerHTML = `
          <div class="card"><h4>Total Items</h4><p class="text-2xl font-bold">${totalItems}</p></div>
          <div class="card"><h4>Total Stock</h4><p class="text-2xl font-bold">${totalStock}</p></div>
          <div class="card"><h4>Total Value</h4><p class="text-2xl font-bold text-pink-600">₹${totalValue}</p></div>
          <div class="card"><h4>Low Stock</h4><p class="text-2xl font-bold text-red-500">${lowStock}</p></div>
        `;

        const grouped = {};
        items.forEach(i => {
          grouped[i.category] = (grouped[i.category] || 0) + i.stock;
        });

        const ctx1 = document.getElementById("stockChart").getContext("2d");
        new Chart(ctx1, {
          type: "bar",
          data: {
            labels: Object.keys(grouped),
            datasets: [{ data: Object.values(grouped), backgroundColor: "#ff9b9b" }]
          }
        });

        const ctx2 = document.getElementById("pieChart").getContext("2d");
        new Chart(ctx2, {
          type: "pie",
          data: {
            labels: Object.keys(grouped),
            datasets: [{ data: Object.values(grouped), backgroundColor: ["#ffb3ba","#ffdfba","#ffffba","#baffc9","#bae1ff"] }]
          }
        });
      } catch (e) {
        console.error(e);
      }
    }

    // Initialize dashboard by default
    loadDashboard();
  </script>
</body>
</html>
